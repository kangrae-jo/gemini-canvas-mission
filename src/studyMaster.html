<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 1); }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* ë§ˆí€´(íë¥´ëŠ” í…ìŠ¤íŠ¸) ì• ë‹ˆë©”ì´ì…˜ */
        .marquee-container {
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            width: 100%;
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .marquee-content {
            display: inline-block;
            animation: marquee 20s linear infinite;
        }
        .marquee-content:hover {
            animation-play-state: paused;
        }
        @keyframes marquee {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        
        /* ì»¤ìŠ¤í…€ ìŠ¤í¬ë¡¤ë°” */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <div id="app" class="max-w-4xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="text-center mb-12 relative">
            <h1 class="text-4xl font-bold text-blue-600 mb-2">Study Master</h1>
            <p class="text-slate-500">í•™ìŠµí•œ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ë§ì¶¤í˜• ë¬¸ì œë¡œ ì‹¤ë ¥ì„ ì ê²€í•˜ì„¸ìš”.</p>
        </header>

        <!-- Step 1: Input Setup -->
        <div id="setup-screen" class="glass-card rounded-2xl p-8 shadow-xl">
            <!-- ì˜¤ë‹µë…¸íŠ¸ ë²„íŠ¼ -->
            <div class="flex justify-end mb-4">
                <button id="btn-open-wrong-note" class="flex items-center gap-2 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 font-bold py-2 px-4 rounded-xl transition-all border border-indigo-200 shadow-sm">
                    <span>ğŸ“š ë‚´ ëˆ„ì  ì˜¤ë‹µë…¸íŠ¸</span>
                    <span id="wrong-note-count-badge" class="bg-indigo-600 text-white text-xs px-2 py-1 rounded-full">0</span>
                </button>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold mb-2">í•™ìŠµ ìë£Œ ë˜ëŠ” í‚¤ì›Œë“œ</label>
                <textarea id="study-content" rows="6" 
                    class="w-full p-4 rounded-xl border border-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all custom-scroll"
                    placeholder="ë¸”ë¡œê·¸ ë‚´ìš©, ê³µì‹ ë¬¸ì„œ í…ìŠ¤íŠ¸ ë˜ëŠ” ì£¼ìš” í‚¤ì›Œë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”..."></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div>
                    <label class="block text-sm font-semibold mb-2">ë‚œì´ë„ ì„¤ì •</label>
                    <select id="difficulty" class="w-full p-3 rounded-xl border border-slate-200 outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="ì‰¬ì›€">ì‰¬ì›€ (ê°œë… ìœ„ì£¼)</option>
                        <option value="ë³´í†µ" selected>ë³´í†µ (ì‘ìš© í¬í•¨)</option>
                        <option value="ì–´ë ¤ì›€">ì–´ë ¤ì›€ (ì‹¬í™” ë° ë³µí•© ê°œë…)</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="generate-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl transition-colors shadow-lg shadow-blue-200">
                        ë¬¸ì œ ìƒì„±í•˜ê¸° (5ë¬¸ì œ)
                    </button>
                </div>
            </div>
            <div id="error-message" class="hidden mt-4 p-4 bg-red-50 text-red-600 rounded-xl text-sm font-medium"></div>
            
            <!-- ì¶”ì²œ í•™ìŠµ í‚¤ì›Œë“œ ì˜ì—­ -->
            <div class="mt-8 pt-6 border-t border-slate-100">
                <h3 class="text-sm font-bold text-slate-500 mb-4 flex items-center justify-center">
                    <span class="mr-2">âœ¨</span> ì¶”ì²œ í•™ìŠµ í‚¤ì›Œë“œ (í´ë¦­í•˜ì—¬ ìë™ ì…ë ¥)
                </h3>
                <div class="marquee-container py-2">
                    <div id="trending-keywords" class="marquee-content flex gap-3 w-max">
                        <!-- Keywords will be injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ëˆ„ì  ì˜¤ë‹µë…¸íŠ¸ í™”ë©´ (ìƒˆë¡œ ì¶”ê°€) -->
        <div id="wrong-note-screen" class="hidden glass-card rounded-2xl p-8 shadow-xl">
            <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    ğŸ“š ë‚˜ì˜ ëˆ„ì  ì˜¤ë‹µë…¸íŠ¸
                </h2>
                <button id="btn-close-wrong-note" class="text-slate-400 hover:text-slate-600 p-2">
                    âœ• ë‹«ê¸°
                </button>
            </div>
            
            <div id="wrong-note-empty" class="hidden text-center py-12 text-slate-500">
                <span class="text-4xl mb-4 block">ğŸ‰</span>
                ì•„ì§ ì €ì¥ëœ ì˜¤ë‹µì´ ì—†ìŠµë‹ˆë‹¤!<br>ë¬¸ì œë¥¼ í’€ê³  ì•½ì ì„ ë³´ì™„í•´ ë³´ì„¸ìš”.
            </div>

            <div id="wrong-note-content">
                <div id="wrong-note-list" class="space-y-4 max-h-96 overflow-y-auto custom-scroll pr-2 mb-6">
                    <!-- ì˜¤ë‹µ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë Œë”ë§ ë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="flex flex-col md:flex-row gap-3 pt-4 border-t border-slate-100">
                    <button id="btn-retake-wrong" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-xl transition-all shadow-lg shadow-indigo-200">
                        ğŸ“ ì €ì¥ëœ ì˜¤ë‹µë§Œ ë‹¤ì‹œ í’€ê¸° (ìµœëŒ€ 20ë¬¸ì œ)
                    </button>
                    <button id="btn-clear-wrong" class="md:w-1/3 bg-white border-2 border-red-100 hover:border-red-300 hover:bg-red-50 text-red-500 font-bold py-3 px-4 rounded-xl transition-all">
                        ğŸ—‘ï¸ ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 2: Loading -->
        <div id="loading-screen" class="hidden glass-card rounded-2xl p-12 text-center shadow-xl">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-slate-200 h-12 w-12 mb-4 mx-auto"></div>
            <h2 class="text-xl font-medium mb-2" id="loading-title">AIê°€ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë¬¸ì œë¥¼ ë§Œë“œëŠ” ì¤‘ì…ë‹ˆë‹¤...</h2>
            <p class="text-slate-500 mb-8" id="loading-desc">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>
            
            <!-- íƒ€ì´ë¨¸ ì„¤ì • ì˜ì—­ -->
            <div id="timer-setup-area" class="max-w-sm mx-auto p-5 bg-blue-50 rounded-xl border border-blue-100 shadow-inner">
                <h3 class="text-sm font-bold text-blue-800 mb-2">â±ï¸ ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ íƒ€ì´ë¨¸ ì„¤ì •</h3>
                <p class="text-xs text-blue-600 mb-4">ë¬¸ì œë‹¹ ì œí•œ ì‹œê°„ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
                <div class="flex items-center justify-center gap-3">
                    <label for="timer-select" class="text-sm font-medium text-slate-600">ì œí•œ ì‹œê°„:</label>
                    <select id="timer-select" class="py-2 px-4 rounded-lg border border-white shadow-sm outline-none focus:ring-2 focus:ring-blue-500 font-bold text-blue-700 bg-white">
                        <!-- Options will be injected by JS -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Step 3: Quiz Screen -->
        <div id="quiz-screen" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="quiz-progress" class="text-sm font-medium text-blue-600 bg-blue-50 px-3 py-1 rounded-full">ë¬¸ì œ 1 / 5</span>
                <span id="quiz-difficulty-tag" class="text-sm font-medium text-slate-500">ë‚œì´ë„: ë³´í†µ</span>
            </div>
            <div class="glass-card rounded-2xl p-8 shadow-xl relative overflow-hidden">
                <!-- íƒ€ì´ë¨¸ í”„ë¡œê·¸ë ˆìŠ¤ ë°” -->
                <div class="absolute top-0 left-0 w-full h-1.5 bg-slate-100">
                    <div id="timer-bar" class="h-full bg-blue-500 transition-all duration-1000 ease-linear" style="width: 100%"></div>
                </div>
                
                <div class="flex justify-between items-end mb-4 mt-2">
                    <span id="question-category" class="text-xs font-bold text-indigo-500 uppercase tracking-wider bg-indigo-50 px-2 py-1 rounded">ì¹´í…Œê³ ë¦¬</span>
                    <!-- í…ìŠ¤íŠ¸ íƒ€ì´ë¨¸ í‘œì‹œ -->
                    <div class="flex items-center text-slate-500 font-bold bg-slate-50 border border-slate-100 px-3 py-1 rounded-full transition-colors duration-300" id="timer-container">
                        <span class="mr-1">â±ï¸</span>
                        <span id="timer-text">00:00</span>
                    </div>
                </div>
                <h2 id="question-text" class="text-xl font-bold mb-6 leading-relaxed">ë¬¸ì œ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</h2>
                <div id="options-container" class="space-y-3">
                    <!-- Options will be injected here -->
                </div>
                <div class="mt-8 flex justify-end">
                    <button id="next-btn" disabled class="bg-slate-200 text-slate-400 font-bold py-3 px-8 rounded-xl cursor-not-allowed transition-all">
                        ë‹¤ìŒ ë¬¸ì œ
                    </button>
                </div>
            </div>
        </div>

        <!-- Step 4: Report Screen -->
        <div id="report-screen" class="hidden">
            <div class="glass-card rounded-2xl p-8 shadow-xl mb-8">
                <div class="text-center mb-8">
                    <div id="score-circle" class="inline-flex items-center justify-center w-24 h-24 rounded-full bg-blue-600 text-white text-3xl font-bold mb-4 shadow-lg shadow-blue-200">
                        4/5
                    </div>
                    <h2 class="text-2xl font-bold mb-2">í•™ìŠµ ë¶„ì„ ë¦¬í¬íŠ¸</h2>
                    <p class="text-slate-500">ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ AIê°€ ë¶„ì„í•œ ë§ì¶¤í˜• í”¼ë“œë°±ì…ë‹ˆë‹¤.</p>
                </div>
                
                <div class="space-y-6">
                    <section>
                        <h3 class="font-bold text-lg mb-3 flex items-center text-slate-800">
                            <span class="mr-2">ğŸ“Š</span> ì¢…í•© í‰ê°€
                        </h3>
                        <div id="report-summary" class="bg-slate-50 p-5 rounded-xl text-slate-700 leading-relaxed whitespace-pre-wrap border border-slate-100">
                            í‰ê°€ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </section>

                    <section>
                        <h3 class="font-bold text-lg mb-3 flex items-center text-red-600">
                            <span class="mr-2">ğŸ¯</span> ë°œê²¬ëœ ì·¨ì•½ì 
                        </h3>
                        <ul id="report-weaknesses" class="bg-red-50 p-5 rounded-xl text-red-800 leading-relaxed list-disc list-inside border border-red-100 space-y-2">
                            <!-- Weaknesses will be injected here -->
                        </ul>
                    </section>

                    <section>
                        <h3 class="font-bold text-lg mb-3 flex items-center text-blue-600">
                            <span class="mr-2">ğŸ’¡</span> ì¶”ì²œ í•™ìŠµ ë°©í–¥
                        </h3>
                        <div id="report-recommendation" class="bg-blue-50 p-5 rounded-xl text-blue-800 leading-relaxed whitespace-pre-wrap border border-blue-100">
                            ì¶”ì²œ ë‚´ìš©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                        </div>
                    </section>
                </div>

                <div class="mt-10 pt-6 border-t border-slate-100 flex flex-col md:flex-row gap-3">
                    <button id="btn-retake" class="flex-1 bg-white border-2 border-slate-200 hover:border-blue-500 hover:text-blue-600 text-slate-700 font-bold py-3 px-2 rounded-xl transition-all shadow-sm">
                        ğŸ”„ ë™ì¼í•œ ë¬¸ì œ ë‹¤ì‹œ í’€ê¸°
                    </button>
                    <button id="btn-more-questions" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-lg shadow-blue-200">
                        âœ¨ ë™ì¼í•œ ë‚´ìš© ìƒˆ ë¬¸ì œ í’€ê¸°
                    </button>
                    <button id="btn-go-home" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 px-2 rounded-xl transition-all shadow-lg">
                        ğŸ  ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    </button>
                </div>
            </div>
            
            <!-- ë¬¸ì œë³„ ì˜¤ë‹µ ë…¸íŠ¸ -->
            <div class="glass-card rounded-2xl p-8 shadow-xl">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl">ğŸ“ ë¬¸í•­ë³„ ìƒì„¸ í’€ì´</h3>
                    <span class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full border border-indigo-100 font-medium">í‹€ë¦° ë¬¸ì œëŠ” ì˜¤ë‹µë…¸íŠ¸ì— ìë™ ì €ì¥ë©ë‹ˆë‹¤</span>
                </div>
                <div id="review-container" class="space-y-6">
                    <!-- Review items will be injected here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const apiKey = ""; // Runtime provides key
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const LOCAL_STORAGE_KEY = 'ai_study_wrong_notes';

        // State Management
        let currentQuiz = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let quizDifficulty = "ë³´í†µ";
        let isRetakeMode = false; // ì˜¤ë‹µë…¸íŠ¸ ë³µìŠµ ëª¨ë“œì¸ì§€ ì—¬ë¶€
        
        // íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜
        let timerInterval;
        let timeLimit = 60; // ê¸°ë³¸ 60ì´ˆ
        let timeRemaining = 60;

        // DOM Elements
        const screens = {
            setup: document.getElementById('setup-screen'),
            loading: document.getElementById('loading-screen'),
            quiz: document.getElementById('quiz-screen'),
            report: document.getElementById('report-screen'),
            wrongNote: document.getElementById('wrong-note-screen')
        };

        const setupUI = {
            content: document.getElementById('study-content'),
            difficulty: document.getElementById('difficulty'),
            generateBtn: document.getElementById('generate-btn'),
            errorMsg: document.getElementById('error-message'),
            btnOpenWrongNote: document.getElementById('btn-open-wrong-note'),
            wrongNoteCount: document.getElementById('wrong-note-count-badge')
        };

        const wrongNoteUI = {
            btnClose: document.getElementById('btn-close-wrong-note'),
            list: document.getElementById('wrong-note-list'),
            emptyState: document.getElementById('wrong-note-empty'),
            contentState: document.getElementById('wrong-note-content'),
            btnRetake: document.getElementById('btn-retake-wrong'),
            btnClear: document.getElementById('btn-clear-wrong')
        };

        const quizUI = {
            progress: document.getElementById('quiz-progress'),
            difficultyTag: document.getElementById('quiz-difficulty-tag'),
            category: document.getElementById('question-category'),
            question: document.getElementById('question-text'),
            options: document.getElementById('options-container'),
            nextBtn: document.getElementById('next-btn'),
            timerText: document.getElementById('timer-text'),
            timerBar: document.getElementById('timer-bar'),
            timerContainer: document.getElementById('timer-container')
        };

        const reportUI = {
            score: document.getElementById('score-circle'),
            summary: document.getElementById('report-summary'),
            weaknesses: document.getElementById('report-weaknesses'),
            recommendation: document.getElementById('report-recommendation'),
            reviewContainer: document.getElementById('review-container'),
            btnRetake: document.getElementById('btn-retake'),
            btnMore: document.getElementById('btn-more-questions'),
            btnHome: document.getElementById('btn-go-home')
        };
        
        // --- íƒ€ì´ë¨¸ ì´ˆê¸°í™” ---
        const timerSelect = document.getElementById('timer-select');
        function initTimerOptions() {
            for (let i = 15; i <= 180; i += 15) {
                const opt = document.createElement('option');
                opt.value = i;
                if (i < 60) opt.innerText = `${i}ì´ˆ`;
                else if (i % 60 === 0) opt.innerText = `${i / 60}ë¶„`;
                else opt.innerText = `${Math.floor(i / 60)}ë¶„ ${i % 60}ì´ˆ`;
                
                if (i === 60) opt.selected = true; // ê¸°ë³¸ê°’ 60ì´ˆ
                timerSelect.appendChild(opt);
            }
        }
        initTimerOptions();

        // --- ì˜¤ë‹µë…¸íŠ¸ ê´€ë ¨ ë¡œì§ (LocalStorage) ---
        function getWrongNotes() {
            return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
        }

        function saveWrongNotes(notes) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(notes));
            updateWrongNoteBadge();
        }

        function updateWrongNoteBadge() {
            const count = getWrongNotes().length;
            setupUI.wrongNoteCount.innerText = count;
            if(count === 0) {
                setupUI.wrongNoteCount.classList.replace('bg-indigo-600', 'bg-slate-300');
            } else {
                setupUI.wrongNoteCount.classList.replace('bg-slate-300', 'bg-indigo-600');
            }
        }

        function renderWrongNoteList() {
            const notes = getWrongNotes();
            wrongNoteUI.list.innerHTML = '';
            
            if (notes.length === 0) {
                wrongNoteUI.emptyState.classList.remove('hidden');
                wrongNoteUI.contentState.classList.add('hidden');
                return;
            }
            
            wrongNoteUI.emptyState.classList.add('hidden');
            wrongNoteUI.contentState.classList.remove('hidden');

            notes.forEach((q, idx) => {
                const div = document.createElement('div');
                div.className = "p-4 bg-white border border-slate-200 rounded-xl hover:border-indigo-300 transition-all";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="text-xs font-bold text-indigo-500 uppercase tracking-wider bg-indigo-50 px-2 py-1 rounded">${q.category}</span>
                        <span class="text-xs text-slate-400">ì €ì¥ì¼: ${new Date(q.savedAt).toLocaleDateString()}</span>
                    </div>
                    <h4 class="font-bold text-slate-800 mb-2">${q.question}</h4>
                    <details class="text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-100">
                        <summary class="font-medium cursor-pointer outline-none hover:text-indigo-600">ì •ë‹µ ë° í•´ì„¤ ë³´ê¸°</summary>
                        <div class="mt-2 pt-2 border-t border-slate-200">
                            <p class="text-green-700 font-medium mb-1">ì •ë‹µ: ${q.options[q.answerIndex]}</p>
                            <p>ğŸ’¡ ${q.explanation}</p>
                        </div>
                    </details>
                `;
                wrongNoteUI.list.appendChild(div);
            });
        }

        // ì˜¤ë‹µë…¸íŠ¸ í™”ë©´ ì—´ê¸°/ë‹«ê¸°/ë¹„ìš°ê¸°
        setupUI.btnOpenWrongNote.addEventListener('click', () => {
            renderWrongNoteList();
            showScreen('wrongNote');
        });
        wrongNoteUI.btnClose.addEventListener('click', () => showScreen('setup'));
        
        // iframe í™˜ê²½ì—ì„œ confirm()ì´ ì°¨ë‹¨ë˜ëŠ” ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ 2ë‹¨ê³„ í„°ì¹˜ ì‚­ì œ êµ¬í˜„
        let isConfirmingClear = false;
        wrongNoteUI.btnClear.addEventListener('click', () => {
            if (!isConfirmingClear) {
                isConfirmingClear = true;
                wrongNoteUI.btnClear.innerHTML = "âš ï¸ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                wrongNoteUI.btnClear.classList.replace('text-red-500', 'text-red-700');
                wrongNoteUI.btnClear.classList.replace('border-red-100', 'border-red-400');
                
                // 3ì´ˆ í›„ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
                setTimeout(() => {
                    isConfirmingClear = false;
                    wrongNoteUI.btnClear.innerHTML = "ğŸ—‘ï¸ ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”";
                    wrongNoteUI.btnClear.classList.replace('text-red-700', 'text-red-500');
                    wrongNoteUI.btnClear.classList.replace('border-red-400', 'border-red-100');
                }, 3000);
            } else {
                saveWrongNotes([]);
                renderWrongNoteList();
                isConfirmingClear = false;
                wrongNoteUI.btnClear.innerHTML = "ğŸ—‘ï¸ ì˜¤ë‹µë…¸íŠ¸ ì´ˆê¸°í™”";
                wrongNoteUI.btnClear.classList.replace('text-red-700', 'text-red-500');
                wrongNoteUI.btnClear.classList.replace('border-red-400', 'border-red-100');
            }
        });

        // ì˜¤ë‹µë§Œ ë‹¤ì‹œ í’€ê¸°
        wrongNoteUI.btnRetake.addEventListener('click', () => {
            let notes = getWrongNotes();
            if (notes.length === 0) return;
            
            // ëœë¤ìœ¼ë¡œ ì„ì–´ì„œ ìµœëŒ€ 20ë¬¸ì œ ì¶”ì¶œ
            const shuffled = notes.sort(() => 0.5 - Math.random());
            currentQuiz = shuffled.slice(0, 20);
            isRetakeMode = true;
            quizDifficulty = "ì˜¤ë‹µ ë³µìŠµ ëª¨ë“œ";
            
            startQuiz(); // API í˜¸ì¶œ ì—†ì´ ë°”ë¡œ í€´ì¦ˆ ì‹œì‘
        });

        // ì´ˆê¸° ë±ƒì§€ ì—…ë°ì´íŠ¸
        updateWrongNoteBadge();

        // --- ì‹¤ì‹œê°„ ì¶”ì²œ í‚¤ì›Œë“œ ---
        let trendingKeywords = [
            "React Hooks", "Python ë°ì´í„° ë¶„ì„", "ìë°”ìŠ¤í¬ë¦½íŠ¸ ë¹„ë™ê¸°", "AWS í´ë¼ìš°ë“œ ê¸°ì´ˆ", 
            "Java ì»¬ë ‰ì…˜/ìŠ¤íŠ¸ë¦¼ ê°œë…", "Spring MVC ìš”ì²­-ì‘ë‹µ íë¦„", "JPA ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ ë™ì‘",
            "ì •ë³´ì²˜ë¦¬ê¸°ì‚¬ ì‹¤ê¸°", "í† ìµ RC ë¬¸ë²•"
        ];

        function renderMarquee() {
            const container = document.getElementById('trending-keywords');
            const displayWords = [...trendingKeywords, ...trendingKeywords];
            container.innerHTML = displayWords.map(word => 
                `<span class="px-4 py-2 bg-slate-50 border border-slate-100 text-slate-600 rounded-full text-sm font-medium cursor-pointer hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition-all shadow-sm" onclick="document.getElementById('study-content').value='${word}'">${word}</span>`
            ).join('');
        }
        renderMarquee();

        // Utility: Show error message
        function showError(msg) {
            setupUI.errorMsg.innerText = msg;
            setupUI.errorMsg.classList.remove('hidden');
        }

        // Utility: API Call with Exponential Backoff
        async function fetchWithRetry(prompt, systemInstruction = "") {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
                generationConfig: { responseMimeType: "application/json" }
            };

            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(`${API_URL}?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('API request failed');
                    const data = await response.json();
                    return JSON.parse(data.candidates[0].content.parts[0].text);
                } catch (error) {
                    console.log(`Retry ${i + 1} failed...`);
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(res => setTimeout(res, delay));
                }
            }
            throw new Error('ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }

        // Action: Generate Quiz
        setupUI.generateBtn.addEventListener('click', async () => {
            isRetakeMode = false;
            await generateQuestions();
        });

        async function generateQuestions() {
            const content = setupUI.content.value.trim();
            quizDifficulty = setupUI.difficulty.value;
            setupUI.errorMsg.classList.add('hidden');

            if (!content) {
                showError("í•™ìŠµ ìë£Œë‚˜ í‚¤ì›Œë“œë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.");
                return;
            }

            document.getElementById('loading-title').innerText = "AIê°€ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë¬¸ì œë¥¼ ë§Œë“œëŠ” ì¤‘ì…ë‹ˆë‹¤...";
            document.getElementById('loading-desc').innerText = "í•™ìŠµ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ 5ê°œì˜ ë§ì¶¤í˜• ë¬¸ì œë¥¼ êµ¬ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤.";
            document.getElementById('timer-setup-area').classList.remove('hidden'); 
            showScreen('loading');
            
            if (content.length <= 20 && !trendingKeywords.includes(content)) {
                trendingKeywords.unshift(content);
                if (trendingKeywords.length > 10) trendingKeywords.pop();
                renderMarquee();
            }

            const systemPrompt = `ë‹¹ì‹ ì€ 1íƒ€ ê°•ì‚¬ ë° êµìœ¡ ì „ë¬¸ê°€ AIì…ë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì œê³µí•œ í•™ìŠµ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ 5ê°œì˜ ê°ê´€ì‹ í€´ì¦ˆë¥¼ ìƒì„±í•˜ì„¸ìš”. 
            ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤. 
            ìŠ¤í‚¤ë§ˆ: { "questions": [{ "question": "ì§ˆë¬¸", "options": ["ë³´ê¸°1", "ë³´ê¸°2", "ë³´ê¸°3", "ë³´ê¸°4"], "answerIndex": 0, "explanation": "í•´ì„¤", "category": "ì£¼ì œ ë¶„ë¥˜(ì˜ˆ: í•µì‹¬ ê°œë…, ì‘ìš©, ë¬¸ë²• ë“±)" }] }`;
            
            const userPrompt = `í•™ìŠµ ë‚´ìš©: "${content}"\në‚œì´ë„: ${quizDifficulty}\nìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ${quizDifficulty} ìˆ˜ì¤€ì˜ ê°ê´€ì‹ 5ë¬¸ì œë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”. ê° ë¬¸ì œëŠ” ì§ˆë¬¸, 4ê°œì˜ ë³´ê¸°, ì •ë‹µ ì¸ë±ìŠ¤(0-3), ì •ë‹µì„ ì„¤ëª…í•˜ëŠ” ìƒì„¸ í•´ì„¤, ê·¸ë¦¬ê³  í•´ë‹¹ ë¬¸ì œê°€ ë‹¤ë£¨ëŠ” ì¹´í…Œê³ ë¦¬(ì†Œì£¼ì œ)ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤. ì´ì „ì— ìƒì„±í–ˆë˜ ë¬¸ì œì™€ ìµœëŒ€í•œ ê²¹ì¹˜ì§€ ì•ŠëŠ” ìƒˆë¡œìš´ ë¬¸ì œë“¤ë¡œ êµ¬ì„±í•´ì£¼ì„¸ìš”.`;

            try {
                const data = await fetchWithRetry(userPrompt, systemPrompt);
                if (!data.questions || data.questions.length !== 5) throw new Error("ë¬¸ì œ ìƒì„± ê·œê²© ì˜¤ë¥˜");
                currentQuiz = data.questions;
                startQuiz();
            } catch (error) {
                showError("ë¬¸ì œ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + error.message);
                showScreen('setup');
            }
        }

        function showScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        function startQuiz() {
            currentQuestionIndex = 0;
            userAnswers = [];
            timeLimit = parseInt(timerSelect.value);
            showScreen('quiz');
            renderQuestion();
        }

        function renderQuestion() {
            clearInterval(timerInterval);
            timeRemaining = timeLimit;
            
            const q = currentQuiz[currentQuestionIndex];
            quizUI.progress.innerText = `ë¬¸ì œ ${currentQuestionIndex + 1} / ${currentQuiz.length}`;
            quizUI.difficultyTag.innerText = `ë‚œì´ë„: ${quizDifficulty}`;
            quizUI.category.innerText = q.category;
            quizUI.question.innerText = q.question;
            quizUI.options.innerHTML = '';
            
            if (userAnswers.length <= currentQuestionIndex) {
                userAnswers.push(null);
            }

            quizUI.nextBtn.disabled = true;
            quizUI.nextBtn.classList.replace('bg-blue-600', 'bg-slate-200');
            quizUI.nextBtn.classList.replace('text-white', 'text-slate-400');
            quizUI.nextBtn.classList.add('cursor-not-allowed');
            quizUI.nextBtn.innerText = currentQuestionIndex === currentQuiz.length - 1 ? "ê²°ê³¼ ë° ë¶„ì„ ë¦¬í¬íŠ¸ ë³´ê¸°" : "ë‹¤ìŒ ë¬¸ì œ";

            q.options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-blue-300 hover:bg-blue-50 transition-all flex items-center group bg-white";
                btn.innerHTML = `
                    <span class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 font-bold flex items-center justify-center mr-3 group-hover:bg-blue-200 group-hover:text-blue-700 transition-colors">${idx + 1}</span>
                    <span class="flex-1 text-slate-700 font-medium">${opt}</span>
                `;
                btn.onclick = () => selectAnswer(idx, btn);
                quizUI.options.appendChild(btn);
            });
            
            startTimer();
        }

        function startTimer() {
            updateTimerUI();
            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerUI();
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    handleNextQuestion();
                }
            }, 1000);
        }

        function updateTimerUI() {
            const minutes = Math.floor(timeRemaining / 60).toString().padStart(2, '0');
            const seconds = (timeRemaining % 60).toString().padStart(2, '0');
            quizUI.timerText.innerText = `${minutes}:${seconds}`;
            
            if (timeRemaining <= 10) {
                quizUI.timerContainer.classList.replace('bg-slate-50', 'bg-red-50');
                quizUI.timerContainer.classList.replace('border-slate-100', 'border-red-200');
                quizUI.timerContainer.classList.replace('text-slate-500', 'text-red-500');
                quizUI.timerContainer.classList.add('animate-pulse');
            } else {
                quizUI.timerContainer.classList.replace('bg-red-50', 'bg-slate-50');
                quizUI.timerContainer.classList.replace('border-red-200', 'border-slate-100');
                quizUI.timerContainer.classList.replace('text-red-500', 'text-slate-500');
                quizUI.timerContainer.classList.remove('animate-pulse');
            }
            
            const percentage = (timeRemaining / timeLimit) * 100;
            quizUI.timerBar.style.width = `${percentage}%`;
            
            if (percentage > 50) quizUI.timerBar.className = "h-full bg-blue-500 transition-all duration-1000 ease-linear";
            else if (percentage > 20) quizUI.timerBar.className = "h-full bg-orange-400 transition-all duration-1000 ease-linear";
            else quizUI.timerBar.className = "h-full bg-red-600 transition-all duration-1000 ease-linear";
        }

        function selectAnswer(index, element) {
            Array.from(quizUI.options.children).forEach(child => {
                child.classList.remove('ring-2', 'ring-blue-500', 'bg-blue-50', 'border-blue-500');
                child.classList.add('border-slate-100', 'bg-white');
            });
            element.classList.remove('border-slate-100', 'bg-white');
            element.classList.add('ring-2', 'ring-blue-500', 'bg-blue-50', 'border-blue-500');

            userAnswers[currentQuestionIndex] = index;
            
            quizUI.nextBtn.disabled = false;
            quizUI.nextBtn.classList.replace('bg-slate-200', 'bg-blue-600');
            quizUI.nextBtn.classList.replace('text-slate-400', 'text-white');
            quizUI.nextBtn.classList.remove('cursor-not-allowed');
            quizUI.nextBtn.innerText = currentQuestionIndex === currentQuiz.length - 1 ? "ê²°ê³¼ ë° ë¶„ì„ ë¦¬í¬íŠ¸ ë³´ê¸°" : "ë‹¤ìŒ ë¬¸ì œ";
        }

        function handleNextQuestion() {
            clearInterval(timerInterval);
            if (currentQuestionIndex < currentQuiz.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                generateReport();
            }
        }

        quizUI.nextBtn.onclick = () => handleNextQuestion();

        async function generateReport() {
            clearInterval(timerInterval);
            document.getElementById('loading-title').innerText = "í•™ìŠµ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì—¬ ë¦¬í¬íŠ¸ë¥¼ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...";
            document.getElementById('loading-desc').innerText = "ì–´ë–¤ ë¶€ë¶„ì´ ë¶€ì¡±í•œì§€ AIê°€ ê¼¼ê¼¼íˆ ì²´í¬í•˜ê³  ìˆìŠµë‹ˆë‹¤.";
            document.getElementById('timer-setup-area').classList.add('hidden');
            showScreen('loading');

            let score = 0;
            let currentSavedNotes = getWrongNotes();

            const resultSummary = currentQuiz.map((q, idx) => {
                const isCorrect = userAnswers[idx] === q.answerIndex;
                if (isCorrect) {
                    score++;
                    // ì •ë‹µì„ ë§ì·„ê³ , ì˜¤ë‹µë…¸íŠ¸ ë³µìŠµ ëª¨ë“œë¼ë©´ ì˜¤ë‹µë…¸íŠ¸ì—ì„œ í•´ë‹¹ ë¬¸ì œ ì œê±°
                    if (isRetakeMode) {
                        currentSavedNotes = currentSavedNotes.filter(note => note.question !== q.question);
                    }
                } else {
                    // í‹€ë ¸ë‹¤ë©´ ì˜¤ë‹µë…¸íŠ¸ì— ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
                    if (!currentSavedNotes.some(note => note.question === q.question)) {
                        currentSavedNotes.push({ ...q, savedAt: new Date().toISOString() });
                    }
                }
                
                const userAnswerText = userAnswers[idx] !== null ? q.options[userAnswers[idx]] : "ì‹œê°„ ì´ˆê³¼ (ë¯¸ì‘ë‹µ)";

                return {
                    question: q.question,
                    category: q.category,
                    isCorrect: isCorrect,
                    userAnswer: userAnswerText,
                    correctAnswer: q.options[q.answerIndex]
                };
            });

            // ì˜¤ë‹µë…¸íŠ¸ ì—…ë°ì´íŠ¸ ë° ë±ƒì§€ ê°±ì‹ 
            saveWrongNotes(currentSavedNotes);

            reportUI.score.innerText = `${score}/${currentQuiz.length}`;
            renderReview(resultSummary);

            const systemPrompt = `ë‹¹ì‹ ì€ ì „ë¬¸ì ì¸ í•™ìŠµ ì½”ì¹˜ì…ë‹ˆë‹¤. ì‚¬ìš©ìì˜ í€´ì¦ˆ í’€ì´ ê²°ê³¼(ì •ë‹µ/ì˜¤ë‹µ, ì£¼ì œ)ë¥¼ ë¶„ì„í•˜ì—¬ ìƒì„¸í•œ í”¼ë“œë°±ì„ ì œê³µí•˜ì„¸ìš”.
            ì‘ë‹µì€ ë°˜ë“œì‹œ JSON í˜•ì‹ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
            ìŠ¤í‚¤ë§ˆ: { "summary": "ê²°ê³¼ í‰ê°€", "weaknesses": ["ì·¨ì•½ì 1"], "recommendation": "í•™ìŠµ ë°©í–¥" }`;

            const modeContext = isRetakeMode ? "ì‚¬ìš©ìê°€ ì˜ˆì „ì— í‹€ë ¸ë˜ ì˜¤ë‹µë…¸íŠ¸ ë³µìŠµ í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤." : "ì‚¬ìš©ìê°€ ìƒˆë¡œ ìƒì„±ëœ í€´ì¦ˆë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.";
            const userPrompt = `${modeContext}
            ì´ì : ${score}/${currentQuiz.length}ì 
            ìƒì„¸ ê²°ê³¼: ${JSON.stringify(resultSummary)}
            ìœ„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ê°•ì ê³¼ ì•½ì ì„ ë¶„ì„í•˜ê³  êµ¬ì²´ì ì¸ ê·¹ë³µ ê°€ì´ë“œë¥¼ ì‘ì„±í•´ ì£¼ì„¸ìš”.`;

            try {
                const reportData = await fetchWithRetry(userPrompt, systemPrompt);
                
                reportUI.summary.innerText = reportData.summary;
                reportUI.weaknesses.innerHTML = '';
                if (reportData.weaknesses && reportData.weaknesses.length > 0) {
                    reportData.weaknesses.forEach(weak => {
                        const li = document.createElement('li');
                        li.innerText = weak;
                        reportUI.weaknesses.appendChild(li);
                    });
                } else {
                    reportUI.weaknesses.innerHTML = '<li>í˜„ì¬ ë°œê²¬ëœ ëšœë ·í•œ ì·¨ì•½ì ì´ ì—†ìŠµë‹ˆë‹¤. ì•„ì£¼ í›Œë¥­í•©ë‹ˆë‹¤!</li>';
                }
                reportUI.recommendation.innerText = reportData.recommendation;
                showScreen('report');
            } catch (error) {
                // alert() ì—­ì‹œ ì°¨ë‹¨ë  ìˆ˜ ìˆìœ¼ë¯€ë¡œ í™”ë©´ì— ë©”ì‹œì§€ ë°”ë¡œ í‘œì‹œë˜ë„ë¡ ë³€ê²½
                reportUI.summary.innerText = "ë¦¬í¬íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
                reportUI.weaknesses.innerHTML = "<li>ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</li>";
                reportUI.recommendation.innerText = "ë‹¤ìŒì— ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ë‹¤ë¥¸ ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                showScreen('report'); 
            }
        }

        function renderReview(results) {
            reportUI.reviewContainer.innerHTML = '';
            
            currentQuiz.forEach((q, idx) => {
                const isCorrect = results[idx].isCorrect;
                const div = document.createElement('div');
                div.className = `p-5 rounded-xl border ${isCorrect ? 'bg-green-50 border-green-100' : 'bg-red-50 border-red-100'}`;
                
                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="${isCorrect ? 'text-green-500' : 'text-red-500'} font-bold text-xl mt-1">
                            ${isCorrect ? 'O' : 'X'}
                        </div>
                        <div class="flex-1">
                            <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">${q.category}</span>
                            <h4 class="font-bold text-slate-800 mb-2">${idx + 1}. ${q.question}</h4>
                            
                            <div class="text-sm mb-3">
                                <p class="${isCorrect ? 'text-green-700' : 'text-red-600'} font-medium mb-1">
                                    ë‚´ ë‹µë³€: ${results[idx].userAnswer}
                                </p>
                                ${!isCorrect ? `<p class="text-green-700 font-medium">ì •ë‹µ: ${q.options[q.answerIndex]}</p>` : ''}
                            </div>
                            
                            <div class="bg-white p-3 rounded-lg text-sm text-slate-600 border border-slate-100">
                                <span class="font-bold text-slate-700">ğŸ’¡ í•´ì„¤:</span> ${q.explanation}
                            </div>
                        </div>
                    </div>
                `;
                reportUI.reviewContainer.appendChild(div);
            });
        }

        // ë²„íŠ¼ ì´ë²¤íŠ¸
        reportUI.btnRetake.addEventListener('click', () => {
            window.scrollTo(0, 0);
            startQuiz();
        });

        reportUI.btnMore.addEventListener('click', async () => {
            window.scrollTo(0, 0);
            isRetakeMode = false;
            await generateQuestions();
        });

        reportUI.btnHome.addEventListener('click', () => {
            window.scrollTo(0, 0);
            setupUI.content.value = ''; // ë‹¤ìŒ í•™ìŠµì„ ìœ„í•´ ì…ë ¥ì°½ ì´ˆê¸°í™”
            showScreen('setup'); // ìƒˆë¡œê³ ì¹¨ ì—†ì´ ì²« í™”ë©´ìœ¼ë¡œ ë¶€ë“œëŸ½ê²Œ ì´ë™
            updateWrongNoteBadge(); // ì˜¤ë‹µë…¸íŠ¸ ë±ƒì§€ ìƒíƒœ í™•ì‹¤í•˜ê²Œ ë™ê¸°í™”
        });

    </script>
</body>
</html>
